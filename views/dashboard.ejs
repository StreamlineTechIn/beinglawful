<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: #f4f4f4;
      display: flex;
    }
    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #1e7e34, #145a32);
      color: #fff;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.5em;
    }
    .sidebar a {
      display: block;
      color: #fff;
      padding: 15px 20px;
      text-decoration: none;
      font-size: 1.1em;
    }
    .sidebar a:hover { background: #51ca6d; }
    .sidebar .note {
      font-size: 0.9em;
      padding: 10px 20px;
      color: #ecf0f1;
    }
    .sidebar .note.missing {
      color: #e74c3c;
      font-style: italic;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
      width: calc(100% - 250px);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1, h3 { color: #333; }
    .section { margin-bottom: 20px; }
    .summary-card {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .summary-item {
      margin: 10px 0;
      font-size: 1em;
    }
    .summary-item span { font-weight: bold; }
    .results-card {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .score-message {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c3e50;
    }
    .test-form button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .test-form button:hover { background: #2980b9; }
    .journey-flow {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
      overflow-x: auto;
    }
    .journey-step {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 100px;
      text-align: center;
      position: relative;
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .journey-step:hover {
      transform: scale(1.1);
    }
    .step-icon {
      font-size: 1.8em;
      margin-bottom: 5px;
      transition: transform 0.3s ease;
    }
    .journey-step:hover .step-icon {
      transform: scale(1.2);
    }
    .step-text {
      font-size: 0.85em;
      font-weight: 500;
      color: #2c3e50;
      line-height: 1.2;
      margin-bottom: 10px;
    }
    .journey-step[data-completed="true"] {
      background: transparent;
    }
    .journey-step[data-completed="true"] .step-icon {
      color: #28a745;
      font-weight: 600;
    }
    .journey-step[data-completed="true"] .step-text {
      color: #28a745;
      font-weight: 600;
    }
    .journey-step[data-completed="true"] .step-text::after {
      content: '✔';
      display: block;
      color: #28a745;
      font-size: 0.9em;
      background: #d4edda;
      border-radius: 50%;
      padding: 2px 6px;
      margin-top: 5px;
      text-align: center;
    }
    .journey-step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 80px;
      right: -50px;
      width: 50px;
      height: 4px;
      background: #2ecc71;
      z-index: 1;
    }
    .journey-step[data-completed="true"]:not(:last-child)::after {
      background: #28a745;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }
    .journey-step[data-completed="true"] .step-icon {
      animation: pulse 1.5s infinite;
    }
    .journey-step.current {
      background: #fff3cd;
      border-radius: 8px;
      padding: 5px;
    }
    .journey-step.current .step-text {
      color: #ffc107;
      font-weight: 600;
    }
    .journey-step.current .step-icon {
      color: #ffc107;
    }
    @media (max-width: 768px) {
      .journey-flow {
        padding: 10px;
      }
      .journey-step {
        width: 80px;
      }
      .step-icon {
        font-size: 1.5em;
      }
      .step-text {
        font-size: 0.75em;
      }
      .journey-step[data-completed="true"] .step-text::after {
        font-size: 0.8em;
        padding: 2px 5px;
      }
      .journey-step:not(:last-child)::after {
        top: 70px;
        right: -40px;
        width: 40px;
      }
    }
    .champion-section {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .champion-badge {
      /* display: inline-flex; */
      display: flex;
      flex-direction: column;
      align-items: center;
      background: transparent;
      padding: 10px;
      border-radius: 20px;
      margin-bottom: 15px;
    }
    .champion-badge img {
      /* width: 100px; */
      /* height: auto; */
    }
    .champion-message {
      color: #28a745;
      font-size: 1.3em;
      font-weight: 600;
      margin: 0;
    }
    .chart-container {
      max-width: 400px;
      margin: 10px auto;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Student Portal</h2>
  <a href="/dashboard/<%= parentMobile1 || '' %>">Dashboard</a>
  <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
    <a href="/gamezone/<%= parentMobile1 || '' %>">Game Zone</a>
    <a href="/certificate/<%= parentMobile1 || '' %>">Certificate</a>
    <a href="/student-dashboard/media-upload/<%= parentMobile1 || '' %>">Upload Media</a>
    <div class="note <%= typeof eventDateMissing !== 'undefined' && eventDateMissing ? 'missing' : '' %>">
      <% if (typeof eventDateMissing !== 'undefined' && eventDateMissing) { %>
        Event date yet to decide.
      <% } else if (typeof isOnOrAfterEventDate !== 'undefined' && isOnOrAfterEventDate) { %>
        Game Zone, Certificate, and Upload Media are now available (since event date: <%= eventDate || 'N/A' %>).
      <% } else { %>
        Game Zone, Certificate, and Upload Media will be available on or after the event date: <%= eventDate || 'N/A' %>.
      <% } %>
    </div>
  <% } %>
  <a href="/login">Logout</a>
</div>

<div class="main-content">
  <div class="container">
    <% console.log('Student Dashboard Data:', { 
        studentName: typeof studentName !== 'undefined' ? studentName : 'undefined', 
        parentMobile1: typeof parentMobile1 !== 'undefined' ? parentMobile1 : 'undefined',
        isChampion: typeof isChampion !== 'undefined' ? isChampion : 'undefined', 
        championMessage: typeof championMessage !== 'undefined' ? championMessage : 'undefined',
        hasCompletedMCQ: typeof hasCompletedMCQ !== 'undefined' ? hasCompletedMCQ : 'undefined',
        eventDateMissing: typeof eventDateMissing !== 'undefined' ? eventDateMissing : 'undefined',
        isOnOrAfterEventDate: typeof isOnOrAfterEventDate !== 'undefined' ? isOnOrAfterEventDate : 'undefined',
        eventDate: typeof eventDate !== 'undefined' ? eventDate : 'undefined'
    }); %>

    <h1>Welcome, <%= studentName || 'Student' %></h1>
    <p>Parent Mobile: <%= parentMobile1 || 'N/A' %></p>

    <% if (typeof isChampion !== 'undefined' && isChampion === true) { %>
      <div class="champion-section">
        <div class="champion-badge">
          <img src="https://media4.giphy.com/media/v1.Y2lkPTc5MGI3NjExM3I5bGF1Z2dpZTZnMmdhY3U1ZWs1eTA4b3JvZnJqaWxhMWE1dXU0ZSZlcD12MV9pbnRlcm5hbF9naWZfYnlfaWQmY3Q9cw/rsORgBADftQBIjTYn9/giphy.gif" alt="Champion GIF" width="100" height="100">
       
          <img src="https://media.giphy.com/media/v1.Y2lkPWVjZjA1ZTQ3b3ZmZDFhZDJ0NDZmNWk5NnpzdDQ5c3M5eTNtdmJqemJrc255NHJnMyZlcD12MV9zdGlja2Vyc19yZWxhdGVkJmN0PXM/MBri2jQyQSbAgRD7LP/giphy.gif" alt="Champion GIF" height=" auto" width="100">
        </div>
        <p class="champion-message"><%= championMessage || 'You’re a Shining Star in the Being Lawful Journey! Keep Rocking!' %></p>
      </div>
      <script>
        // Confetti animation for champion
        window.addEventListener('DOMContentLoaded', function () {
          confetti({
            particleCount: 250,
            spread: 120,
            angle: 90,
            origin: { y: 0.4 },
            colors: ['#28a745', '#ffd700', '#6ab04c', '#ffeaa7']
          });
        });
      </script>
      <script>
        console.log('Champion Section:', {
          isChampion: <%= JSON.stringify(typeof isChampion !== 'undefined' ? isChampion : false) %>,
          championMessage: <%= JSON.stringify(typeof championMessage !== 'undefined' ? championMessage : '') %>
        });
      </script>
    <% } %>

    <div class="section">
      <h3>Test Summary</h3>
      <div class="summary-card">
        <div class="summary-item"><span>Trial Test 1:</span> <%= typeof hasCompletedTrial1 !== 'undefined' && hasCompletedTrial1 ? 'Completed' : 'Not Completed' %></div>
        <div class="summary-item"><span>Trial Test 2:</span> <%= typeof hasCompletedTrial2 !== 'undefined' && hasCompletedTrial2 ? 'Completed' : 'Not Completed' %></div>
        <div class="summary-item"><span>Main Exam:</span> <%= typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ ? 'Completed' : 'Not Started' %></div>
        <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
          <div class="summary-item"><span>Main Exam Score:</span> <%= typeof score !== 'undefined' && typeof totalQuestions !== 'undefined' ? `${score}/${totalQuestions} (${percentage}%)` : 'N/A' %></div>
        <% } %>
      </div>
    </div>  

    <div class="section">
      <h3>🛤️ Your Being Lawful Journey</h3>
      <div class="journey-flow">
        <div class="journey-step" data-step="1" data-completed="true">
          <span class="step-icon">📝</span>
          <span class="step-text">Registration</span>
        </div>
        <div class="journey-step" data-step="2" data-completed="<%= typeof hasCompletedRegistration !== 'undefined' && hasCompletedRegistration ? 'true' : 'false' %>">
          <span class="step-icon">🏫</span>
          <span class="step-text">Approved by School</span>
        </div>
        <div class="journey-step" data-step="3" data-completed="<%= typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ ? 'true' : 'false' %>">
          <span class="step-icon">📚</span>
          <span class="step-text">MCQ Test</span>
        </div>
        <div class="journey-step" data-step="4" data-completed="<%= typeof hasCertificate !== 'undefined' && hasCertificate ? 'true' : 'false' %>">
          <span class="step-icon">🏆</span>
          <span class="step-text">Certificate Issued</span>
        </div>
        <div class="journey-step" data-step="5" data-completed="<%= typeof hasAttendedWorkshop !== 'undefined' && hasAttendedWorkshop ? 'true' : 'false' %>">
          <span class="step-icon">🎤</span>
          <span class="step-text">Workshop Attended</span>
        </div>
        <div class="journey-step" data-step="6" data-completed="<%= typeof isChampion !== 'undefined' && isChampion ? 'true' : 'false' %>">
          <span class="step-icon">🌟</span>
          <span class="step-text">Champion</span>
        </div>
        <div class="journey-step" data-step="7" data-completed="<%= typeof hasUploadedMedia !== 'undefined' && hasUploadedMedia ? 'true' : 'false' %>">
          <span class="step-icon">📸</span>
          <span class="step-text">Media Upload</span>
        </div>
        <div class="journey-step" data-step="8" data-completed="<%= typeof isJudiciarySelected !== 'undefined' && isJudiciarySelected ? 'true' : 'false' %>">
          <span class="step-icon">⚖️</span>
          <span class="step-text">Judiciary Selection</span>
        </div>
        <div class="journey-step" data-step="9" data-completed="<%= typeof isStateFelicitated !== 'undefined' && isStateFelicitated ? 'true' : 'false' %>">
          <span class="step-icon">🎉</span>
          <span class="step-text">State Felicitation</span>
        </div>
      </div>
    </div>

    <% if (typeof hasCompletedTrial1 === 'undefined' || !hasCompletedTrial1) { %>
      <div class="section">
        <h3>Trial Test 1</h3>
        <form class="test-form" action="/submit-trial1" method="POST">
          <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
          <% if (typeof trial1 !== 'undefined' && trial1.length > 0) { %>
            <% trial1.forEach(function(mcq, index) { %>
              <p><%= mcq.question || 'Question not available' %></p>
              <% (mcq.options || []).forEach(function(option) { %>
                <label><input type="radio" name="q<%= index %>" value="<%= option %>" required> <%= option %></label><br>
              <% }); %>
            <% }); %>
            <button type="submit">Submit Trial 1</button>
          <% } else { %>
            <p>No questions available for Trial Test 1.</p>
          <% } %>
        </form>
      </div>
    <% } else { %>
      <div class="section"><h3>Trial Test 1</h3><p>You have completed Trial Test 1.</p></div>
    <% } %>

    <% if (typeof hasCompletedTrial2 === 'undefined' || !hasCompletedTrial2) { %>
      <div class="section">
        <h3>Trial Test 2</h3>
        <form class="test-form" action="/submit-trial2" method="POST">
          <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
          <% if (typeof trial2 !== 'undefined' && trial2.length > 0) { %>
            <% trial2.forEach(function(mcq, index) { %>
              <p><%= mcq.question || 'Question not available' %></p>
              <% (mcq.options || []).forEach(function(option) { %>
                <label><input type="radio" name="q<%= index %>" value="<%= option %>" required> <%= option %></label><br>
              <% }); %>
            <% }); %>
            <button type="submit">Submit Trial 2</button>
          <% } else { %>
            <p>No questions available for Trial Test 2.</p>
          <% } %>
        </form>
      </div>
    <% } else { %>
      <div class="section"><h3>Trial Test 2</h3><p>You have completed Trial Test 2.</p></div>
    <% } %>

    <% if (typeof hasCompletedTrial1 !== 'undefined' && hasCompletedTrial1 && typeof hasCompletedTrial2 !== 'undefined' && hasCompletedTrial2 && (typeof hasCompletedMCQ === 'undefined' || !hasCompletedMCQ)) { %>
      <div class="section">
        <h3>Main Exam</h3>
        <p>You have <%= typeof mcqs !== 'undefined' && mcqs.length > 0 ? mcqs.length : 0 %> questions to complete.</p>
        <a href="/mcq-test/<%= parentMobile1 || '' %>" style="padding: 10px 20px; background: #3498db; color: #fff; text-decoration: none; border-radius: 5px;">Start Main Exam</a>
      </div>
    <% } %>

    <% if (typeof showResults !== 'undefined' && showResults && typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
      <div class="section">
        <h3>Main Exam Results</h3>
        <div class="results-card">
          <div class="score-message">Your Score: <%= typeof score !== 'undefined' && typeof totalQuestions !== 'undefined' ? `${score}/${totalQuestions} (${percentage}%)` : 'N/A' %></div>
          
        </div>
      </div>
      <script>
        document.addEventListener('DOMContentLoaded', () => {
          const ctx = document.getElementById('examResultsChart').getContext('2d');
          new Chart(ctx, {
            type: 'bar',
            data: {
              labels: ['Trial Test 1', 'Trial Test 2', 'Main Exam'],
              datasets: [{
                label: 'Status',
                data: [
                  <%= typeof hasCompletedTrial1 !== 'undefined' && hasCompletedTrial1 ? 100 : 0 %>,
                  <%= typeof hasCompletedTrial2 !== 'undefined' && hasCompletedTrial2 ? 100 : 0 %>,
                  <%= typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ ? 100 : 0 %>
                ],
                backgroundColor: ['#2ecc71', '#2ecc71', '#3498db'],
                borderColor: ['#27ae60', '#27ae60', '#2980b9'],
                borderWidth: 1
              }]
            },
            options: {
              scales: {
                y: {
                  beginAtZero: true,
                  max: 100,
                  title: {
                    display: true,
                    text: 'Completion (%)'
                  }
                }
              },
              plugins: {
                legend: {
                  display: false
                }
              }
            }
          });
        });
      </script>
    <% } %>

    <% if (typeof isEventDate !== 'undefined' && isEventDate) { %>
      <div class="section">
        <p style="color: #e74c3c; font-weight: bold;">Today is the event date!</p>
      </div>
    <% } %>

    <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ && typeof showMediaSection !== 'undefined' && showMediaSection) { %>
      <div class="section">
        <h3>Upload Your Media</h3>
        <form action="/student-dashboard/upload-media" method="POST" enctype="multipart/form-data" class="test-form">
          <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
          <p>Media Description (Max 1000 words):</p>
          <textarea name="mediaDescription" rows="4" style="width: 100%; margin-bottom: 10px;" required></textarea>
          <p>External Media Link (Optional):</p>
          <input type="url" name="mediaLink" style="width: 100%; margin-bottom: 10px;" placeholder="https://yourlink.com">
          <p>Upload Photos (Max 2):</p>
          <input type="file" name="photos" accept="image/*" multiple style="margin-bottom: 10px;">
          <p>Upload Videos (Max 2):</p>
          <input type="file" name="videos" accept="video/*" multiple style="margin-bottom: 10px;">
          <button type="submit">Upload Media</button>
        </form>
      </div>
      <div class="section">
        <h3>Your Uploaded Media</h3>
        <% if (typeof mediaUploads !== 'undefined' && mediaUploads.length > 0) { %>
          <% mediaUploads.forEach(function(media) { %>
            <div style="margin-bottom: 15px; background: #ecf0f1; padding: 10px; border-radius: 5px;">
              <% if (media.type === 'image') { %>
                <img src="<%= media.url %>" alt="Uploaded Image" style="max-width: 100%;">
              <% } else if (media.type === 'video') { %>
                <video controls style="max-width: 100%;">
                  <source src="<%= media.url %>" type="video/mp4">
                  Your browser does not support the video tag.
                </video>
              <% } %>
              <p><strong>Description:</strong> <%= media.description || 'No description' %></p>
              <% if (media.link) { %>
                <p><strong>Link:</strong> <a href="<%= media.link %>" target="_blank"><%= media.link %></a></p>
              <% } %>
            </div>
          <% }); %>
        <% } else { %>
          <p>No media uploaded yet.</p>
        <% } %>
      </div>
    <% } %>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const steps = document.querySelectorAll('.journey-step');
    let lastCompletedStep = 0;
    steps.forEach((step, index) => {
      if (step.dataset.completed === 'true') {
        lastCompletedStep = Math.max(lastCompletedStep, parseInt(step.dataset.step));
      }
    });
    steps.forEach((step) => {
      const stepNumber = parseInt(step.dataset.step);
      if (stepNumber === lastCompletedStep + 1) {
        step.classList.add('current');
      }
    });
  });
</script>

</body>
</html>