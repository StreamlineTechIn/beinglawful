<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Student Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background-color: #f4f4f4;
      display: flex;
    }
    .sidebar {
      width: 250px;
      background: linear-gradient(180deg, #1e7e34, #145a32);
      color: #fff;
      height: 100vh;
      position: fixed;
      padding-top: 20px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
    }
    .sidebar h2 {
      text-align: center;
      margin-bottom: 30px;
      font-size: 1.5em;
    }
    .sidebar a {
      display: block;
      color: #fff;
      padding: 15px 20px;
      text-decoration: none;
      font-size: 1.1em;
    }
    .sidebar a:hover { background: #51ca6d; }
    .sidebar .note {
      font-size: 0.9em;
      padding: 10px 20px;
      color: #ecf0f1;
    }
    .sidebar .note.missing {
      color: #e74c3c;
      font-style: italic;
    }
    .main-content {
      margin-left: 250px;
      padding: 20px;
      width: calc(100% - 250px);
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1, h3 { color: #333; }
    .section { margin-bottom: 20px; }
    .summary-card {
      background: #ecf0f1;
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }
    .summary-item {
      margin: 10px 0;
      font-size: 1em;
    }
    .summary-item span { font-weight: bold; }
    .results-card {
      background: #e8f4f8;
      padding: 15px;
      border-radius: 5px;
      margin-top: 10px;
    }
    .score-message {
      font-size: 1.2em;
      font-weight: bold;
      color: #2c3e50;
    }
    .test-form button {
      margin-top: 10px;
      padding: 10px 20px;
      background: #3498db;
      color: #fff;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .test-form button:hover { background: #2980b9; }
    .journey-flow div {
      display: flex;
      align-items: center;
      font-size: 1.1em;
      padding: 8px 0;
      border-left: 4px solid #2ecc71;
      padding-left: 10px;
      margin-bottom: 5px;
      background: #f9f9f9;
      border-radius: 4px;
    }
    .journey-flow div span {
      margin-right: 10px;
      font-weight: bold;
      color: #27ae60;
    }
    .journey-flow {
      background: #ecf0f1;
      border-radius: 8px;
      padding: 15px;
    }
    .champion-section {
      background: #d4edda;
      border: 2px solid #28a745;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
      position: relative;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .champion-badge {
      display: inline-flex;
      align-items: center;
      background: #28a745;
      color: #fff;
      padding: 10px 20px;
      border-radius: 20px;
      font-size: 1.2em;
      font-weight: bold;
      text-transform: uppercase;
      margin-bottom: 15px;
    }
    .champion-badge::before {
      content: 'üéñ';
      margin-right: 8px;
      font-size: 1.4em;
    }
    .champion-message {
      color: #28a745;
      font-size: 1.3em;
      font-weight: 600;
      margin: 0;
    }
  </style>
</head>
<body>

<div class="sidebar">
  <h2>Student Portal</h2>
  <a href="/dashboard/<%= parentMobile1 || '' %>">Dashboard</a>
  <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
    <a href="/gamezone/<%= parentMobile1 || '' %>">Game Zone</a>
    <a href="/certificate/<%= parentMobile1 || '' %>">Certificate</a>
    <div class="note <%= typeof eventDateMissing !== 'undefined' && eventDateMissing ? 'missing' : '' %>">
      <% if (typeof eventDateMissing !== 'undefined' && eventDateMissing) { %>
        Event date yet to decide.
      <% } else if (typeof isOnOrAfterEventDate !== 'undefined' && isOnOrAfterEventDate) { %>
        Game Zone and Certificate are now available (since event date: <%= eventDate || 'N/A' %>).
      <% } else { %>
        Game Zone and Certificate will be available on or after the event date: <%= eventDate || 'N/A' %>.
      <% } %>
    </div>
    <% if (typeof eventDateMissing === 'undefined' || !eventDateMissing && typeof isOnOrAfterEventDate !== 'undefined' && isOnOrAfterEventDate) { %>
      <a href="/student-dashboard/media-upload/<%= parentMobile1 || '' %>">Upload Media</a>
    <% } else { %>
      <div class="note missing">Upload Media will be available on or after the event date: <%= eventDate || 'N/A' %>.</div>
    <% } %>
  <% } %>
  <a href="/login">Logout</a>
</div>

<div class="main-content">
  <div class="container">
    <!-- Debugging Log -->
    <% console.log('Student Dashboard Data:', { 
        studentName: typeof studentName !== 'undefined' ? studentName : 'undefined', 
        parentMobile1: typeof parentMobile1 !== 'undefined' ? parentMobile1 : 'undefined',
        isChampion: typeof isChampion !== 'undefined' ? isChampion : 'undefined', 
        championMessage: typeof championMessage !== 'undefined' ? championMessage : 'undefined',
        hasCompletedMCQ: typeof hasCompletedMCQ !== 'undefined' ? hasCompletedMCQ : 'undefined',
        eventDateMissing: typeof eventDateMissing !== 'undefined' ? eventDateMissing : 'undefined',
        isOnOrAfterEventDate: typeof isOnOrAfterEventDate !== 'undefined' ? isOnOrAfterEventDate : 'undefined',
        eventDate: typeof eventDate !== 'undefined' ? eventDate : 'undefined'
    }); %>

    <h1>Welcome, <%= studentName || 'Student' %></h1>
    <p>Parent Mobile: <%= parentMobile1 || 'N/A' %></p>

    <% if (typeof isChampion !== 'undefined' && isChampion === true) { %>
      <div class="champion-section">
        <div class="champion-badge">Champion</div>
        <p class="champion-message"><%= championMessage || 'Selected as champion for Being Lawful' %></p>
      </div>
      <!-- Browser Console Log for Champion Section -->
      <script>
        console.log('Champion Section:', {
          isChampion: <%= JSON.stringify(typeof isChampion !== 'undefined' ? isChampion : false) %>,
          championMessage: <%= JSON.stringify(typeof championMessage !== 'undefined' ? championMessage : '') %>
        });
      </script>
    <% } %>

    <div class="section">
      <h3>Test Summary</h3>
      <div class="summary-card">
        <div class="summary-item"><span>Trial Test 1:</span> <%= typeof hasCompletedTrial1 !== 'undefined' && hasCompletedTrial1 ? 'Completed' : 'Not Completed' %></div>
        <div class="summary-item"><span>Trial Test 2:</span> <%= typeof hasCompletedTrial2 !== 'undefined' && hasCompletedTrial2 ? 'Completed' : 'Not Completed' %></div>
        <div class="summary-item"><span>Main Exam:</span> <%= typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ ? 'Completed' : 'Not Started' %></div>
        <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
          <div class="summary-item"><span>Main Exam Score:</span> <%= typeof score !== 'undefined' && typeof totalQuestions !== 'undefined' ? `${score}/${totalQuestions} (${percentage}%)` : 'N/A' %></div>
        <% } %>
      </div>
    </div>

    <!-- Student Journey Flow -->
    <div class="section">
      <h3>üõ§Ô∏è Your Being Lawful Journey</h3>
      <div class="summary-card journey-flow">
        <div><span>1Ô∏è‚É£</span> Registration</div>
        <div><span>2Ô∏è‚É£</span> Approved by School</div>
        <div><span>3Ô∏è‚É£</span> MCQ Test (Main Exam)</div>
        <div><span>4Ô∏è‚É£</span> Certificate Issued</div>
        <div><span>5Ô∏è‚É£</span> Workshop Attended</div>
        <div><span>6Ô∏è‚É£</span> Being Lawful Champion</div>
        <div><span>7Ô∏è‚É£</span> Media Upload</div>
        <div><span>8Ô∏è‚É£</span> Judiciary Selection</div>
        <div><span>9Ô∏è‚É£</span> State Level Felicitation</div>
      </div>
    </div>

    <% if (typeof hasCompletedTrial1 === 'undefined' || !hasCompletedTrial1) { %>
      <div class="section">
        <h3>Trial Test 1</h3>
        <form class="test-form" action="/submit-trial1" method="POST">
          <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
          <% if (typeof trial1 !== 'undefined' && trial1.length > 0) { %>
            <% trial1.forEach(function(mcq, index) { %>
              <p><%= mcq.question || 'Question not available' %></p>
              <% (mcq.options || []).forEach(function(option) { %>
                <label><input type="radio" name="q<%= index %>" value="<%= option %>" required> <%= option %></label><br>
              <% }); %>
            <% }); %>
            <button type="submit">Submit Trial 1</button>
          <% } else { %>
            <p>No questions available for Trial Test 1.</p>
          <% } %>
        </form>
      </div>
    <% } else { %>
      <div class="section"><h3>Trial Test 1</h3><p>You have completed Trial Test 1.</p></div>
    <% } %>

    <% if (typeof hasCompletedTrial2 === 'undefined' || !hasCompletedTrial2) { %>
      <div class="section">
        <h3>Trial Test 2</h3>
        <form class="test-form" action="/submit-trial2" method="POST">
          <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
          <% if (typeof trial2 !== 'undefined' && trial2.length > 0) { %>
            <% trial2.forEach(function(mcq, index) { %>
              <p><%= mcq.question || 'Question not available' %></p>
              <% (mcq.options || []).forEach(function(option) { %>
                <label><input type="radio" name="q<%= index %>" value="<%= option %>" required> <%= option %></label><br>
              <% }); %>
            <% }); %>
            <button type="submit">Submit Trial 2</button>
          <% } else { %>
            <p>No questions available for Trial Test 2.</p>
          <% } %>
        </form>
      </div>
    <% } else { %>
      <div class="section"><h3>Trial Test 2</h3><p>You have completed Trial Test 2.</p></div>
    <% } %>

    <% if (typeof hasCompletedTrial1 !== 'undefined' && hasCompletedTrial1 && typeof hasCompletedTrial2 !== 'undefined' && hasCompletedTrial2 && (typeof hasCompletedMCQ === 'undefined' || !hasCompletedMCQ)) { %>
      <div class="section">
        <h3>Main Exam</h3>
        <p>You have <%= typeof mcqs !== 'undefined' && mcqs.length > 0 ? mcqs.length : 0 %> questions to complete.</p>
        <a href="/mcq-test/<%= parentMobile1 || '' %>" style="padding: 10px 20px; background: #3498db; color: #fff; text-decoration: none; border-radius: 5px;">Start Main Exam</a>
      </div>
    <% } %>

    <% if (typeof showResults !== 'undefined' && showResults && typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ) { %>
      <div class="section">
        <h3>Main Exam Results</h3>
        <div class="results-card">
          <div class="score-message">Your Score: <%= typeof score !== 'undefined' && typeof totalQuestions !== 'undefined' ? `${score}/${totalQuestions} (${percentage}%)` : 'N/A' %></div>
        </div>
      </div>
    <% } %>

    <% if (typeof isEventDate !== 'undefined' && isEventDate) { %>
      <div class="section">
        <p style="color: #e74c3c; font-weight: bold;">Today is the event date!</p>
      </div>
    <% } %>

    <!-- Media Upload Section -->
    <% if (typeof hasCompletedMCQ !== 'undefined' && hasCompletedMCQ && typeof isOnOrAfterEventDate !== 'undefined' && isOnOrAfterEventDate) { %>
      <% if (typeof showMediaSection !== 'undefined' && showMediaSection) { %>
        <div class="section">
          <h3>Upload Your Media</h3>
          <form action="/student-dashboard/upload-media" method="POST" enctype="multipart/form-data" class="test-form">
            <input type="hidden" name="parentMobile1" value="<%= parentMobile1 || '' %>">
            <p>Media Description (Max 1000 words):</p>
            <textarea name="mediaDescription" rows="4" style="width: 100%; margin-bottom: 10px;" required></textarea>
            <p>External Media Link (Optional):</p>
            <input type="url" name="mediaLink" style="width: 100%; margin-bottom: 10px;" placeholder="https://yourlink.com">
            <p>Upload Photos (Max 2):</p>
            <input type="file" name="photos" accept="image/*" multiple style="margin-bottom: 10px;">
            <p>Upload Videos (Max 2):</p>
            <input type="file" name="videos" accept="video/*" multiple style="margin-bottom: 10px;">
            <button type="submit">Upload Media</button>
          </form>
        </div>

        <div class="section">
          <h3>Your Uploaded Media</h3>
          <% if (typeof mediaUploads !== 'undefined' && mediaUploads.length > 0) { %>
            <% mediaUploads.forEach(function(media) { %>
              <div style="margin-bottom: 15px; background: #ecf0f1; padding: 10px; border-radius: 5px;">
                <% if (media.type === 'image') { %>
                  <img src="<%= media.url %>" alt="Uploaded Image" style="max-width: 100%;">
                <% } else if (media.type === 'video') { %>
                  <video controls style="max-width: 100%;">
                    <source src="<%= media.url %>" type="video/mp4">
                    Your browser does not support the video tag.
                  </video>
                <% } %>
                <p><strong>Description:</strong> <%= media.description || 'No description' %></p>
                <% if (media.link) { %>
                  <p><strong>Link:</strong> <a href="<%= media.link %>" target="_blank"><%= media.link %></a></p>
                <% } %>
              </div>
            <% }); %>
          <% } else { %>
            <p>No media uploaded yet.</p>
          <% } %>
        </div>
      <% } %>
    <% } %>
  </div>
</div>

</body>
</html>